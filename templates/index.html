{% extends 'base.html' %}
{% block content %}
<div class="row g-0 position-relative" style="height: calc(100vh - 120px);">
  <div class="col-12 col-lg-9 p-0 h-100">
    <div id="map" class="h-100 w-100"></div>
  </div>
  <div class="col-12 col-lg-3 h-100 border-start bg-white p-3 sidebar" id="sidebar">
    <h5 class="mb-3 text-primary">Registrar Buraco</h5>

    <div class="filters card card-body p-2 mb-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="chkConcluded">
        <label class="form-check-label" for="chkConcluded">Mostrar conclu√≠dos</label>
      </div>
      <div class="mt-2">
        <label class="form-label mb-1">Bairro/Regi√£o</label>
        <div class="input-group input-group-sm">
          <input id="bairroFilter" class="form-control" placeholder="Digite um bairro/regi√£o">
          <button class="btn btn-outline-primary" id="btnUseGPS" title="Usar minha localiza√ß√£o">üìç</button>
        </div>
        <small class="text-muted">Dica: clique no mapa para preencher lat/lng e sugerir bairro automaticamente.</small>
      </div>
    </div>

    <form id="regForm" method="post" action="{{ url_for('submit') }}" enctype="multipart/form-data">
      <input type="hidden" name="neighborhood" id="neighborhoodHidden">
      <div class="mb-2">
        <label class="form-label">T√≠tulo</label>
        <input name="title" class="form-control" placeholder="Ex: Cratera na Av. X">
      </div>
      <div class="mb-2">
        <label class="form-label">Descri√ß√£o</label>
        <textarea name="description" class="form-control" rows="3" placeholder="Ex: Muito profundo, pr√≥ximo ao n¬∫ 100"></textarea>
      </div>
      <div class="mb-2">
        <label class="form-label">Imagem (at√© 2MB)</label>
        <input id="imageField" name="image" type="file" accept="image/*" class="form-control">
        <div id="preview" class="mt-2"></div>
      </div>
      <div class="row">
        <div class="col-6 mb-2">
          <label class="form-label">Latitude</label>
          <input id="lat" name="lat" class="form-control" placeholder="-23.55">
        </div>
        <div class="col-6 mb-2">
          <label class="form-label">Longitude</label>
          <input id="lng" name="lng" class="form-control" placeholder="-46.63">
        </div>
      </div>
      <div class="d-grid gap-2">
        <button class="btn btn-primary">Registrar</button>
      </div>
    </form>
    <hr>
    <h6 class="text-primary">Registros</h6>
    <div id="listRecords" style="max-height: 30vh; overflow:auto;"></div>
  </div>
  <button class="btn btn-primary fab" id="togglePanel" title="Abrir/Fechar painel de registro">‚ûï Registrar</button>
</div>

<script>
const map = L.map('map', { zoomControl: true }).setView([-23.5505, -46.6333], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap',
  detectRetina: true
}).addTo(map);

let markers = L.layerGroup().addTo(map);

map.on('click', async function(e){
  document.getElementById('lat').value = e.latlng.lat.toFixed(6);
  document.getElementById('lng').value = e.latlng.lng.toFixed(6);
  try {
    const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}&zoom=15&addressdetails=1`,
      { headers: { 'Accept-Language': 'pt-BR' } });
    const js = await resp.json();
    const addr = js.address || {};
    const bairro = addr.suburb || addr.neighbourhood || addr.city_district || addr.village || addr.town || addr.city || '';
    document.getElementById('neighborhoodHidden').value = bairro || '';
  } catch(err) { /* ignora */ }
});

async function loadHoles(){
  markers.clearLayers();
  const showConc = document.getElementById('chkConcluded').checked ? '1' : '0';
  const bairro = encodeURIComponent(document.getElementById('bairroFilter').value.trim());
  const res = await fetch(`{{ url_for('api_holes') }}?show_concluded=${showConc}&neighborhood=${bairro}`);
  const data = await res.json();
  const list = document.getElementById('listRecords'); list.innerHTML='';
  data.forEach(h => {
    const m = L.marker([h.lat, h.lng]).addTo(markers);
    let html = `<b>${h.title || 'Sem t√≠tulo'}</b><br>${h.description || ''}`;
    if (h.neighborhood) html += `<br><small><b>Bairro:</b> ${h.neighborhood}</small>`;
    html += `<br><small>${new Date(h.created_at).toLocaleString()}</small>`;
    if (h.image) {
      html += `<br><img src='{{ url_for('uploads', filename='') }}${h.image}' style='max-width:220px;margin-top:6px;border-radius:6px;'>`;
    }
    html += `<br>
      <form method='post' action='${'{{ url_for("conclude", hid=0) }}'.replace('0', h.id)}' onsubmit="setTimeout(loadHoles, 600)">
        <button class='btn btn-sm btn-success mt-2'>Concluir</button>
      </form>`;
    m.bindPopup(html);

    const card = document.createElement('div');
    card.className = 'record-card';
    card.innerHTML = `<div class="fw-bold">${h.title || 'Sem t√≠tulo'}</div>
                      <div class="small text-muted">${h.neighborhood ? ('Bairro: '+h.neighborhood) : ''}</div>`;
    card.addEventListener('click', () => { map.setView([h.lat, h.lng], 16); m.openPopup(); });
    list.appendChild(card);
  });
}

document.getElementById('imageField').addEventListener('change', function(ev){
  const file = ev.target.files[0];
  const preview = document.getElementById('preview');
  preview.innerHTML = '';
  if (!file) return;
  if (!file.type.startsWith('image/')) { preview.innerHTML='<div class="text-danger">Arquivo n√£o √© imagem.</div>'; ev.target.value=''; return; }
  if (file.size > 2*1024*1024) { preview.innerHTML='<div class="text-danger">Imagem excede 2MB.</div>'; ev.target.value=''; return; }
  const reader = new FileReader();
  reader.onload = e => { const img = document.createElement('img'); img.src=e.target.result; img.style.maxWidth='100%'; img.style.borderRadius='6px'; preview.appendChild(img); };
  reader.readAsDataURL(file);
});

const panel = document.getElementById('sidebar');
const toggler = document.getElementById('togglePanel');
toggler.addEventListener('click', () => {
  panel.classList.toggle('collapsed');
  toggler.textContent = panel.classList.contains('collapsed') ? '‚ûï Registrar' : '‚úñ Fechar';
});

document.getElementById('chkConcluded').addEventListener('change', loadHoles);
document.getElementById('bairroFilter').addEventListener('input', loadHoles);

document.getElementById('btnUseGPS').addEventListener('click', async (e) => {
  e.preventDefault();
  if (!navigator.geolocation) return alert('Geolocaliza√ß√£o n√£o suportada.');
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const { latitude, longitude } = pos.coords;
    map.setView([latitude, longitude], 15);
    try {
      const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=15&addressdetails=1`,
        { headers: { 'Accept-Language': 'pt-BR' } });
      const js = await resp.json();
      const addr = js.address || {};
      const bairro = addr.suburb || addr.neighbourhood || addr.city_district || addr.village || addr.town || addr.city || '';
      document.getElementById('bairroFilter').value = bairro || '';
      loadHoles();
    } catch(err) { /* ignore */ }
  }, () => alert('N√£o foi poss√≠vel obter sua localiza√ß√£o.'));
});

loadHoles();
</script>
{% endblock %}
