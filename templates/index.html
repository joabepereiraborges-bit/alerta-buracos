{% extends 'base.html' %}
{% block content %}
<div class="row" style="height: calc(100vh - 80px);">
  <div class="col-md-9 p-0">
    <div id="map" style="height:100%;"></div>
  </div>
  <div class="col-md-3 p-3 sidebar">
    <h5>Registrar Buraco</h5>
    <form id="regForm" method="post" action="{{ url_for('submit') }}" enctype="multipart/form-data">
      <div class="mb-2">
        <label class="form-label">Título</label>
        <input name="title" class="form-control">
      </div>
      <div class="mb-2">
        <label class="form-label">Descrição</label>
        <textarea name="description" class="form-control" rows="3"></textarea>
      </div>
      <div class="mb-2">
        <label class="form-label">Imagem (≤2MB)</label>
        <input id="imageField" name="image" type="file" accept="image/*" class="form-control">
        <div id="preview" class="mt-2"></div>
      </div>
      <div class="mb-2">
        <label class="form-label">Latitude</label>
        <input id="lat" name="lat" class="form-control">
      </div>
      <div class="mb-2">
        <label class="form-label">Longitude</label>
        <input id="lng" name="lng" class="form-control">
      </div>
      <div class="d-grid">
        <button class="btn btn-primary">Registrar</button>
      </div>
    </form>
    <hr>
    <h6>Registros</h6>
    <div id="listRecords" style="max-height:35vh; overflow:auto;"></div>
    {% if user and user['is_admin'] == 1 %}
      <div class="mt-3"><a href="{{ url_for('admin_panel') }}" class="btn btn-danger w-100">Painel Admin</a></div>
    {% endif %}
  </div>
</div>

<script>
const map = L.map('map').setView([-23.5505, -46.6333], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'© OpenStreetMap'
}).addTo(map);
let markers = L.layerGroup().addTo(map);

map.on('click', function(e){
  document.getElementById('lat').value = e.latlng.lat.toFixed(6);
  document.getElementById('lng').value = e.latlng.lng.toFixed(6);
});

async function loadHoles(){
  markers.clearLayers();
  const res = await fetch('{{ url_for('api_holes') }}');
  const data = await res.json();
  const list = document.getElementById('listRecords'); list.innerHTML='';
  data.forEach(h=>{
    const m = L.marker([h.lat,h.lng]).addTo(markers);
    let html = `<b>${h.title}</b><br>${h.description}<br><small>${new Date(h.created_at).toLocaleString()}</small>`;
    if(h.image){ html += `<br><img src='{{ url_for('uploads','') }}${h.image}' style='max-width:200px;margin-top:6px;border-radius:6px;'>`; }
    html += `<br><form method='post' action='{{ url_for('conclude', id=0) }}'.replace('0', h.id) ><button class='btn btn-sm btn-success mt-2'>Concluir</button></form>`;
    m.bindPopup(html);
    const el = document.createElement('div'); el.className='p-2 border rounded mb-2';
    el.innerHTML = `<b>${h.title}</b><br><small>${h.description}</small>`;
    el.addEventListener('click', ()=>{ map.setView([h.lat,h.lng],16); m.openPopup(); });
    list.appendChild(el);
  });
}

document.getElementById('imageField').addEventListener('change', function(ev){
  const file = ev.target.files[0];
  const preview = document.getElementById('preview');
  preview.innerHTML='';
  if(!file) return;
  if(!file.type.startsWith('image/')) { preview.innerHTML='<div class="text-danger">Arquivo não é imagem.</div>'; ev.target.value=''; return; }
  if(file.size > 2*1024*1024) { preview.innerHTML='<div class="text-danger">Imagem excede 2MB.</div>'; ev.target.value=''; return; }
  const reader = new FileReader();
  reader.onload = function(e){ const img = document.createElement('img'); img.src = e.target.result; img.style.maxWidth='100%'; preview.appendChild(img); };
  reader.readAsDataURL(file);
});

loadHoles();
</script>
{% endblock %}